map $request_method $cors_method {
  default "allowed";
  "OPTIONS" "preflight";
}

map $cors_method $cors_max_age {
  default "";
  "preflight" 3600;
}

map $cors_method $cors_allow_methods {
  default "";
  "preflight" "GET, POST, OPTIONS";
}

map $cors_method $cors_allow_headers {
  default "";
  "preflight" "Authorization,Content-Type,Accept,Origin,User-Agent,Cache-Control,Keep-Alive,If-Modified-Since";
}

map $cors_method $cors_content_length {
  default $initial_content_length;
  "preflight" 0;
}

map $cors_method $cors_content_type {
  default $initial_content_type;
  "preflight" "text/plain charset=UTF-8";
}

server {
  listen 443 ssl default_server;
  listen [::]:443 ssl default_server;
  server_name ca.imovies.ch;
  root /var/www/html;

  ssl_certificate /opt/tls/certificate.crt;
  ssl_certificate_key /opt/tls/private.key;

  # https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=773332
  gzip off;

  # add CORS headers
  add_header Access-Control-Allow-Origin "https://imovies.ch";
  add_header Access-Control-Allow-Credentials 'false';
  add_header Access-Control-Max-Age $cors_max_age;
  add_header Access-Control-Allow-Methods $cors_allow_methods;
  add_header Access-Control-Allow-Headers $cors_allow_headers;

  # add some security headers

  # prevent rendering in iframes
  add_header X-Frame-Options "DENY";
  # prevent downgrade attacks, 31536000 = year in seconds
  add_header Strict-Transport-Security "max-age=31536000; includeSubdomains; preload";
  # default-src 'self' *.imovies.ch: all content comes from the same domain or an imovie subdomain
  # only using https, data schemes (base64) or blobs

  add_header Content-Security-Policy "default-src 'self' *.imovies.ch https: data: blob:" always;

  # if the browser detects a reflected XSS attack, it stops rendering
  add_header X-XSS-Protection "1; mode=block";

  location / {
    proxy_set_header   X-Forwarded-For $remote_addr;

    # add client certificate as a header
    proxy_set_header   X-SSL-CERT-SERIAL $ssl_client_serial;

    proxy_set_header   Host $http_host;
    proxy_pass         http://127.0.0.1:3000;
	}
}

server {
  listen 443 ssl;
  listen [::]:443 ssl;
  server_name auth.imovies.ch;
  root /var/www/html;

  ssl_certificate /opt/tls/certificate.crt;
  ssl_certificate_key /opt/tls/private.key;

  # https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=773332
  gzip off;

  # add CORS headers
  add_header Access-Control-Allow-Origin "https://imovies.ch";
  add_header Access-Control-Allow-Credentials 'false';
  add_header Access-Control-Max-Age $cors_max_age;
  add_header Access-Control-Allow-Methods $cors_allow_methods;
  add_header Access-Control-Allow-Headers $cors_allow_headers;

  # add some security headers

  # prevent rendering in iframes
  add_header X-Frame-Options "DENY";
  # prevent downgrade attacks, 31536000 = year in seconds
  add_header Strict-Transport-Security "max-age=31536000; includeSubdomains; preload";

  add_header Content-Security-Policy "default-src 'self' https: data: blob:" always;

  # if the browser detects a reflected XSS attack, it stops rendering
  add_header X-XSS-Protection "1; mode=block";

  # for client certificates
  ssl_client_certificate "/opt/CA/cacert.pem";
  ssl_crl "/opt/CA/crl/revoked.pem";
  
  # require authentication using TLS client certificates
  ssl_verify_client on;

  location /authentication/tls-cert {
    proxy_set_header   X-Forwarded-For $remote_addr;

    # add client certificate as a header
    proxy_set_header   X-SSL-CERT-SERIAL $ssl_client_serial;

    proxy_set_header   Host $http_host;
    proxy_pass         http://127.0.0.1:3000;
	}
}